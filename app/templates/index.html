{% extends "base/hexo_index.html" %}

{% block copyright %}
    {{copyright|safe}}
{% endblock %}

{% block index_image %}
<div class="layer" data-depth="0.4">
    <img src="{{ index_imageurl }}" id="cover" width="1920" height="1080">    
</div>
{% endblock %}

{% block page0 %}
    <!-- <p>date</p> -->
    {%if welcome %}
    <div id="post0"> 
        <h2><a href="{{welcome.href}}" title="{{ welcome.title }}" class="posttitle">{{ welcome.title }}</a></h2>
        <p class="summary">
            {{ welcome.abstract }}
        </p>
    </div>
    {% else %}
    <div id="post0">
        <h2><a href="{{ url_for('article.archive', filename = 'welcome') }}" title="Welcome" class="posttitle">Welcome1</a></h2>
        <p class="summary">
            再次感谢原作者创作出这么精美的主题 @Fechin @LoeiFy
        </p>
        {% if p_here %}
        <p class="here">
            <span class="icon-letter">p_here.letter</span>
            <span class="icon-view">p_here.view</span>
            <a href="javascript:;" class="likeThis active" id="like-6537"><span class="icon-like"></span><span class="count">p_here.like</span></a>        
        </p>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block archives %}
    {% for item in archives %}
        <div class="post">
            <a href="{{ item.href }}" title="{{item.title}}" class="posttitle">
                <img src="{{ item.imgurl }}" class="cover" width="680" height="440">
            </a>
            <div class="else">
                <p>{{ item.date }}</p>
                <h3><a href="{{ item.href }}" title="{{ item.title }}" class="posttitle">{{ item.title }}</a></h3>
                <p>{{ item.abstract }}</p>
            </div>
        </div>   
    {% endfor %}       
{% endblock %} 

{% block idnex_more %}
    {% if more %}
      <div id="pager"><a href="{{ more }}" class="more" id = "moreurl" οnclick="new_json()">加载更多</a></div>
    {% endif%}
{% endblock %}  

{% block gov %} 
<p id = "gov" style="text-align: center;">
    {{ gov }}
</p>
{% endblock  %} 

{% block why_js_is_here %}   
<!-- <script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
<!-- <link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/atelier-heath-dark.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script> -->
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="{{ url_for('static', filename = 'js/plugin.js' ) }}"></script>
<script src="{{ url_for('static', filename = 'js/diaspora.js' ) }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename = 'photoswipe/photoswipe.css' ) }}">
<link rel="stylesheet" href="{{ url_for('static', filename = 'photoswipe/default-skin/default-skin.css' ) }}">
<script src="{{ url_for('static', filename = 'photoswipe/photoswipe.min.js' ) }}"></script>
<script src="{{ url_for('static', filename = 'photoswipe/photoswipe-ui-default.min.js' ) }}"></script>
<!-- <script >hljs.initHighlightingOnLoad();</script>   -->
{% endblock %}  

{% block add_script %}
<script>

// 后面是我增加的 

var get_json_tur = true;
var site_indexpath = '/'
var json_xhr = new XMLHttpRequest();

function add_archive(data){
    // console.log("已进入");
    // console.log("data:",data);
    // console.log(data["data"], data.data, data.more);
    var primary = document.getElementById('primary');
    var more_a = document.getElementById("moreurl");
    var now_y = getScrollTop();
    for (index in data.data){ 
        item = data.data[index];
        // console.log("item",item);
        if(document.getElementById(item.filename)){
            continue;
        }
        var new_div_post = document.createElement("div");
        var new_a = document.createElement("a");
        var new_img = document.createElement("img");
        var new_div_else = document.createElement("div");
        var new_else_h = document.createElement("h3");
        var new_else_a = document.createElement("a");
        var new_pdate = document.createElement("p");
        var new_abstract = document.createElement("p");

        new_div_post.className = "post";
        new_div_else.className = 'else'
        new_else_a.className = 'posttitle';

        new_div_post.id = item.filename;
        new_a.href = item.href;
        new_img.src = item.imgurl;
        new_a.appendChild(new_img);

        new_div_post.appendChild(new_a);

        new_pdate.innerHTML = item.date;
        new_abstract.innerHTML = item.abstract;
        
        new_else_a.href = item.href;
        new_else_a.title = item.title;
        new_else_a.text = item.title;

        new_else_h.appendChild(new_else_a);
        new_div_else.appendChild(new_pdate);            
        new_div_else.appendChild(new_else_h);
        new_div_else.appendChild(new_abstract);
        
        new_div_post.appendChild(new_div_else);

        primary.append(new_div_post);
        
        // console.log("append done");
        if (data.more){
            if (data.more == "end"){
                get_json_tur = false;
                more_a.innerHTML = "没有更多";
                more_a.href = "";
                more_a.onclick = remove_pager;
            }
            else{
                more_a.innerHTML = "加载更多";
                more_a.href = data.more;
            }
        }
        scrollTo(0,now_y);
    } 
} 

// 请求json flag变量 如果到最后就不再判断


// 该函数只在首页有效 加载文章
function new_json(){
    // console.log("URL", window.document.URL, window.location.pathname);
    if (window.location.pathname != site_indexpath){
        // console.log("URL:", window.document.URL,"pathname : ",  window.location.pathname);
        // console.log("if window.location.pathname != site_indexpath --> True")
        return 
    }else{
        // console.log("URL:", window.document.URL,"pathname : ",  window.location.pathname);
    } 
    var more_a = document.getElementById("moreurl");
    if (!more_a){
        return ;
    }
    more_a.innerHTML = "加载中...";
    var jsonurl = more_a.href 
    json_xhr.open('GET', jsonurl);
    var count = 0
    json_xhr.onreadystatechange = function (){ 
        count = count +1 
        var data = json_xhr.responseText;
        if (data){
            data = JSON.parse(data); 
            add_archive(data);
        } 
    }  
    json_xhr.send(); 
}

$(window).scroll(function () {
//如果窗口划过的距离等于  页面高度减窗口高度   就说明已经到底部了 
if (get_json_tur ){ 
    if ($(window).scrollTop() == $(document).height() - $(window).height() ) {  
            new_json(); 
    }}
});    

// 获取滚动条坐标
function getScrollTop(){ 
var scrollTop=0; 
if(document.documentElement&&document.documentElement.scrollTop){ 
    scrollTop=document.documentElement.scrollTop; 
}else if(document.body){ 
    scrollTop=document.body.scrollTop; 
} 
return scrollTop; 
}  

// 首页加载完毕时调用js 加载文章数据
window.onload=function(){ 
if (this.document.getElementsByClassName('post').length < 1 ){
    new_json();
}
else {
    // console.log(this.document.getElementsByClassName('post').length )
}
};

// 已经没有数据的时候 再次点击加载更多 会消失
function remove_pager() { 
    $('#pager').remove();
}
</script>
{% endblock %}
